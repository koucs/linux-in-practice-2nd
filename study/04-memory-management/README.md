
[図解でわかるSpectreとMeltdown](https://speakerdeck.com/sat/tu-jie-dewakaruspectretomeltdown)
[Reading privileged memory with a side-channel](https://googleprojectzero.blogspot.com/2018/01/reading-privileged-memory-with-side.html)
[Meltdown: Reading Kernel Memory from User Space](https://www.usenix.org/conference/usenixsecurity18/presentation/lipp)

## mmap

```s
$ ./mmap 
*** 新規メモリ領域獲得前のメモリマップ ***
...
7f860365f000-7f8605910000 rw-p 00000000 00:00 0 
...

*** 新規メモリ領域: アドレス = 0x7f85c365f000, サイズ = 0x40000000 ***

*** 新規メモリ領域獲得後のメモリマップ ***
...
7f85c365f000-7f8605910000 rw-p 00000000 00:00 0 
...
```

0x7f860365f000 - 0x7f85c365f000 = 0x40000000

## [p95] システム全体のメモリ使用量

```s
$ python demand-paging.py 
13:17:26: 新規メモリ領域獲得前。Enterキーを押すと100MiBの新規メモリ領域を獲得します

13:17:31: 新規メモリ領域を獲得しました。Enterキーを押すと1秒に10MiBづつ、合計100MiBの新規メモリ領域にアクセスします

13:17:35: 10 MiB アクセスしました
13:17:36: 20 MiB アクセスしました
13:17:37: 30 MiB アクセスしました
13:17:38: 40 MiB アクセスしました
13:17:39: 50 MiB アクセスしました
13:17:40: 60 MiB アクセスしました
13:17:41: 70 MiB アクセスしました
13:17:42: 80 MiB アクセスしました
13:17:43: 90 MiB アクセスしました
13:17:44: 新規獲得したメモリ領域のすべてのアクセスしました。Enterキーを押すと終了します
```

```s
$ sar -r 1
Linux 5.10.60.1-microsoft-standard-WSL2 (COU-WIN10)     07/02/23        _x86_64_        (24 CPU)

13:17:21    kbmemfree   kbavail kbmemused  %memused kbbuffers  kbcached  kbcommit   %commit  kbactive   kbinact   kbdirty
13:17:22     13844036  15233800    695020      4.25    488360    968280   1557952      7.58   1065336    768712         0
...
13:17:33     13824992  15214804    714024      4.37    488376    968280   1688544      8.22   1065356    787644       132
13:17:34     13825096  15214908    713920      4.37    488376    968280   1688544      8.22   1065360    787524       132
13:17:35     13825096  15214908    713920      4.37    488384    968272   1688544      8.22   1065360    787524       132
13:17:36     13814352  15204164    724664      4.43    488384    968272   1689060      8.22   1065360    798440       132
13:17:37     13803332  15193144    735684      4.50    488384    968272   1690192      8.23   1065368    809084       132
13:17:38     13793612  15183424    745404      4.56    488384    968272   1689060      8.22   1065360    819256       132
13:17:39     13783388  15173200    755628      4.62    488384    968272   1689060      8.22   1065360    829496       132
13:17:40     13773148  15162960    765868      4.69    488392    968264   1689060      8.22   1065360    839736       132
13:17:41     13762908  15152720    776108      4.75    488392    968264   1689060      8.22   1065360    849976       132
13:17:42     13750964  15140816    788020      4.82    488392    968280   1690192      8.23   1065392    860560       132
13:17:43     13741056  15130908    797928      4.88    488392    968280   1689060      8.22   1065384    870528       132
13:17:44     13730824  15120676    808160      4.94    488392    968280   1689060      8.22   1065384    880768       132
13:17:45     13721120  15110972    817864      5.00    488400    968272   1689060      8.22   1065384    890460       132
13:17:46     13721120  15110972    817864      5.00    488400    968272   1689060      8.22   1065384    890460       132
13:17:47     13720044  15109896    818936      5.01    488400    968272   1690192      8.23   1065384    891340       132
```



## [p96] 全体のページフォールト発生の様子を確認

```s
$ python demand-paging.py 
13:23:08: 新規メモリ領域獲得前。Enterキーを押すと100MiBの新規メモリ領域を獲得します

13:23:09: 新規メモリ領域を獲得しました。Enterキーを押すと1秒に10MiBづつ、合計100MiBの新規メモリ領域にアクセスします

13:23:10: 10 MiB アクセスしました
13:23:11: 20 MiB アクセスしました
13:23:12: 30 MiB アクセスしました
13:23:13: 40 MiB アクセスしました
13:23:14: 50 MiB アクセスしました
13:23:15: 60 MiB アクセスしました
13:23:16: 70 MiB アクセスしました
13:23:17: 80 MiB アクセスしました
13:23:18: 90 MiB アクセスしました
13:23:19: 新規獲得したメモリ領域のすべてのアクセスしました。Enterキーを押すと終了します
```

```s
$ sar -B 1
Linux 5.10.60.1-microsoft-standard-WSL2 (COU-WIN10)     07/02/23        _x86_64_        (24 CPU)

13:23:05     pgpgin/s pgpgout/s   fault/s  majflt/s  pgfree/s pgscank/s pgscand/s pgsteal/s    %vmeff
13:23:06         0.00      0.00      4.00      0.00    549.00      0.00      0.00      0.00      0.00
13:23:07         0.00     12.00     67.00      0.00    259.00      0.00      0.00      0.00      0.00
13:23:08         0.00      0.00  13976.00      0.00   6004.00      0.00      0.00      0.00      0.00
13:23:09         0.00      0.00     39.00      0.00      9.00      0.00      0.00      0.00      0.00
13:23:10         0.00      0.00   2149.00      0.00   1572.00      0.00      0.00      0.00      0.00
13:23:11         0.00      0.00   1103.00      0.00    597.00      0.00      0.00      0.00      0.00
13:23:12         0.00     12.00   2252.00      0.00   1569.00      0.00      0.00      0.00      0.00
13:23:13         0.00      0.00    794.00      0.00    628.00      0.00      0.00      0.00      0.00
13:23:14         0.00     56.00   2242.00      0.00   1567.00      0.00      0.00      0.00      0.00
13:23:15         0.00      0.00    811.00      0.00    619.00      0.00      0.00      0.00      0.00
13:23:16         0.00      0.00     21.00      0.00    517.00      0.00      0.00      0.00      0.00
13:23:17         0.00     12.00   8189.00      0.00   2214.00      0.00      0.00      0.00      0.00
13:23:18         0.00      0.00     20.00      0.00      7.00      0.00      0.00      0.00      0.00
13:23:19         0.00      0.00   2242.00      0.00   1569.00      0.00      0.00      0.00      0.00
13:23:20         0.00      0.00   2157.00      0.00    852.00      0.00      0.00      0.00      0.00
13:23:21         0.00      0.00      5.00      0.00      5.00      0.00      0.00      0.00      0.00
13:23:22        96.00     12.00    884.00      1.00  31306.00      0.00      0.00      0.00      0.00
13:23:23         0.00      0.00     44.00      0.00      7.00      0.00      0.00      0.00      0.00
13:23:24         0.00      0.00   1988.00      0.00   1467.00      0.00      0.00      0.00      0.00
13:23:25         0.00      0.00    594.00      0.00    465.00      0.00      0.00      0.00      0.00
```
fault/s が増えている


## [p97] demand-paging プロセス単体の情報

```s
$ python demand-paging.py 
13:36:32: 新規メモリ領域獲得前。Enterキーを押すと100MiBの新規メモリ領域を獲得します

13:37:47: 新規メモリ領域を獲得しました。Enterキーを押すと1秒に10MiBづつ、合計100MiBの新規メモリ領域にアクセスします

13:37:51: 10 MiB アクセスしました
13:37:52: 20 MiB アクセスしました
13:37:53: 30 MiB アクセスしました
13:37:54: 40 MiB アクセスしました
13:37:55: 50 MiB アクセスしました
13:37:56: 60 MiB アクセスしました
13:37:57: 70 MiB アクセスしました
13:37:58: 80 MiB アクセスしました
13:37:59: 90 MiB アクセスしました
13:38:00: 新規獲得したメモリ領域のすべてのアクセスしました。Enterキーを押すと終了します
```

```s
$ sh ./capture.sh
Sun Jul  2 13:37:36 JST 2023:  85628 55700      0   6330
Sun Jul  2 13:37:37 JST 2023:  85628 55700      0   6330
Sun Jul  2 13:37:38 JST 2023:  85628 55700      0   6330
Sun Jul  2 13:37:39 JST 2023:  85628 55700      0   6330
Sun Jul  2 13:37:40 JST 2023:  85628 55700      0   6330
Sun Jul  2 13:37:41 JST 2023:  85628 55700      0   6330
Sun Jul  2 13:37:42 JST 2023:  85628 55700      0   6330
Sun Jul  2 13:37:43 JST 2023:  85628 55700      0   6330
Sun Jul  2 13:37:44 JST 2023:  85628 55700      0   6330
Sun Jul  2 13:37:45 JST 2023:  85628 55700      0   6330
Sun Jul  2 13:37:46 JST 2023:  85628 55700      0   6330
Sun Jul  2 13:37:47 JST 2023:  85628 55700      0   6330
Sun Jul  2 13:37:48 JST 2023: 188028 55700      0   6335 <= メモリ領域確保 
Sun Jul  2 13:37:49 JST 2023: 188028 55700      0   6335
Sun Jul  2 13:37:50 JST 2023: 188028 55700      0   6335 
Sun Jul  2 13:37:51 JST 2023: 188028 55700      0   6335 
Sun Jul  2 13:37:52 JST 2023: 188544 67344      0   6598 <= 物理メモリ使用量が増える
Sun Jul  2 13:37:53 JST 2023: 188544 77584      0   6603
Sun Jul  2 13:37:54 JST 2023: 188544 87824      0   6608
Sun Jul  2 13:37:55 JST 2023: 188544 98064      0   6613
Sun Jul  2 13:37:56 JST 2023: 188544 108304     0   6618
Sun Jul  2 13:37:57 JST 2023: 188544 118544     0   6623
Sun Jul  2 13:37:58 JST 2023: 188544 129304     0   6628
Sun Jul  2 13:37:59 JST 2023: 188544 139544     0   6633
Sun Jul  2 13:38:00 JST 2023: 188544 149784     0   6638
Sun Jul  2 13:38:01 JST 2023: 188544 158964     0   6925
Sun Jul  2 13:38:02 JST 2023: 188544 158964     0   6925
Sun Jul  2 13:38:03 JST 2023: demand-paging.pyプロセスは終了しました。
```

## トランスペアレントヒュージページ

```s
$ cat /sys/kernel/mm/transparent_hugepage/enabled
[always] madvise never
```

madvise: madvise()というシステムコールに MADV_HUGEPAGE というフラグを設定することによって、明に指定したメモリ領域についてのみ有効